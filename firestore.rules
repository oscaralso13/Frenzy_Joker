rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Reglas para la colección de usuarios
    match /users/{userId} {

      // LECTURA: Un usuario puede leer su propio documento
      // También permitimos lectura pública solo de ciertos campos para el leaderboard
      allow read: if request.auth != null && (
        request.auth.uid == userId || // El propio usuario
        resource.data.keys().hasOnly(['username', 'stats']) // O solo stats públicas
      );

      // CREACIÓN: Solo cuando un usuario se registra y el ID coincide con su UID
      allow create: if request.auth != null
        && request.auth.uid == userId
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.email == request.auth.token.email;

      // ACTUALIZACIÓN: Solo el propio usuario puede actualizar su documento
      allow update: if request.auth != null
        && request.auth.uid == userId
        // No permitir modificar campos críticos (userId, email, createdAt)
        && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['userId', 'email', 'createdAt'])
        // Validaciones anti-trampas solo si se modifican las stats
        && (
          // Si NO se modifican las stats, permitir (para lastLogin, savedGame, etc.)
          !request.resource.data.diff(resource.data).affectedKeys().hasAny(['stats'])
          // O si se modifican las stats, validar que sean razonables
          || (
            request.resource.data.stats.highScore >= 0
            && request.resource.data.stats.highScore <= 100000 // Límite más alto
            && request.resource.data.stats.gamesPlayed >= resource.data.stats.gamesPlayed // Solo puede incrementar
            && request.resource.data.stats.totalScore >= resource.data.stats.totalScore // Solo puede incrementar
          )
        );

      // ELIMINACIÓN: No permitir eliminar documentos de usuario
      // (en producción podrías crear una Cloud Function para esto)
      allow delete: if false;
    }

    // Regla por defecto: denegar todo lo demás
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
